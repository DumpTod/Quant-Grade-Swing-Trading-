<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>QUANT SCANNER â€” World-Class Multi-Layer Trading Scanner</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800;900&family=JetBrains+Mono:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        /* ============================================================
           RESET & BASE
           ============================================================ */
        * { margin: 0; padding: 0; box-sizing: border-box; }

        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
            background: #f0f2f5;
            color: #2c3e50;
            min-height: 100vh;
            overflow-x: hidden;
        }

        /* ============================================================
           CUSTOM SCROLLBAR
           ============================================================ */
        ::-webkit-scrollbar { width: 6px; }
        ::-webkit-scrollbar-track { background: #e8ecf1; }
        ::-webkit-scrollbar-thumb { background: #8dabc4; border-radius: 3px; }
        ::-webkit-scrollbar-thumb:hover { background: #4682b4; }

        /* ============================================================
           COLOR SYSTEM â€” Steel Blue Base
           ============================================================ */
        :root {
            --steel-900: #1a3a5c;
            --steel-800: #1e4976;
            --steel-700: #2a6496;
            --steel-600: #3a7cb8;
            --steel-500: #4682b4;
            --steel-400: #6a9ec9;
            --steel-300: #8dabc4;
            --steel-200: #b0c7d9;
            --steel-100: #d4e1ec;
            --steel-50: #ecf1f7;

            --green-600: #16a34a;
            --green-500: #22c55e;
            --green-400: #4ade80;
            --green-100: #dcfce7;
            --green-50: #f0fdf4;

            --red-600: #dc2626;
            --red-500: #ef4444;
            --red-400: #f87171;
            --red-100: #fee2e2;
            --red-50: #fef2f2;

            --bg: #f0f2f5;
            --card-bg: #ffffff;
            --card-border: #d4e1ec;
            --text-primary: #1a3a5c;
            --text-secondary: #4a6a8a;
            --text-muted: #8dabc4;
        }

        /* ============================================================
           HEADER
           ============================================================ */
        .header {
            background: linear-gradient(135deg, #1a3a5c 0%, #2a6496 50%, #4682b4 100%);
            padding: 28px 40px;
            position: relative;
            overflow: hidden;
            box-shadow: 0 4px 20px rgba(26, 58, 92, 0.3);
        }

        .header::before {
            content: '';
            position: absolute;
            top: -50%; left: -50%;
            width: 200%; height: 200%;
            background: radial-gradient(ellipse at 30% 50%, rgba(255,255,255,0.05) 0%, transparent 70%);
            animation: headerPulse 8s ease-in-out infinite;
        }

        @keyframes headerPulse {
            0%, 100% { opacity: 0.5; transform: scale(1); }
            50% { opacity: 1; transform: scale(1.05); }
        }

        .header-content {
            position: relative; z-index: 2;
            max-width: 1500px; margin: 0 auto;
            display: flex; align-items: center;
            justify-content: space-between; flex-wrap: wrap; gap: 16px;
        }

        .header-left { display: flex; flex-direction: column; gap: 4px; }

        .header-title {
            font-size: 1.8em; font-weight: 900;
            letter-spacing: 3px; color: #ffffff;
            text-shadow: 0 2px 10px rgba(0,0,0,0.2);
        }

        .header-title span { color: #b0c7d9; font-weight: 400; font-size: 0.5em; letter-spacing: 1px; }

        .header-subtitle {
            font-size: 0.78em; color: #b0c7d9;
            letter-spacing: 0.5px; font-weight: 400;
        }

        .header-subtitle b { color: #ffffff; font-weight: 600; }

        .scan-btn {
            padding: 14px 40px;
            background: #ffffff;
            border: none; border-radius: 10px;
            color: var(--steel-800); font-size: 0.95em;
            font-weight: 800; letter-spacing: 2px;
            cursor: pointer; transition: all 0.3s;
            text-transform: uppercase;
            box-shadow: 0 4px 15px rgba(0,0,0,0.15);
            font-family: 'Inter', sans-serif;
        }

        .scan-btn:hover {
            background: #ecf1f7;
            box-shadow: 0 6px 25px rgba(0,0,0,0.2);
            transform: translateY(-2px);
        }

        .scan-btn:active { transform: translateY(0); }
        .scan-btn:disabled { opacity: 0.5; cursor: not-allowed; transform: none; }

        /* ============================================================
           STATUS BAR
           ============================================================ */
        .status-bar {
            background: #ffffff;
            border-bottom: 1px solid var(--steel-100);
            padding: 10px 40px;
            display: flex; align-items: center;
            gap: 28px; flex-wrap: wrap;
            box-shadow: 0 1px 4px rgba(0,0,0,0.04);
        }

        .status-item {
            display: flex; align-items: center;
            gap: 7px; font-size: 0.78em;
        }

        .status-dot {
            width: 9px; height: 9px; border-radius: 50%;
            background: #b0c7d9; transition: all 0.3s;
        }

        .status-dot.ready { background: var(--green-500); box-shadow: 0 0 8px rgba(34,197,94,0.4); animation: dotPulse 2s ease-in-out infinite; }
        .status-dot.scanning { background: #f59e0b; box-shadow: 0 0 8px rgba(245,158,11,0.4); animation: dotPulse 0.6s ease-in-out infinite; }
        .status-dot.error { background: var(--red-500); box-shadow: 0 0 8px rgba(239,68,68,0.4); }

        @keyframes dotPulse { 0%,100%{opacity:1} 50%{opacity:0.3} }

        .status-label { color: var(--text-muted); font-weight: 500; }
        .status-value { color: var(--steel-800); font-weight: 700; }

        .regime-badge {
            padding: 3px 12px; border-radius: 6px;
            font-weight: 700; font-size: 0.75em;
            letter-spacing: 1px; text-transform: uppercase;
        }

        .regime-bull { background: var(--green-100); color: var(--green-600); }
        .regime-bear { background: var(--red-100); color: var(--red-600); }
        .regime-sideways { background: #fef9c3; color: #a16207; }
        .regime-unknown { background: var(--steel-50); color: var(--steel-500); }

        /* ============================================================
           MODEL LEGEND
           ============================================================ */
        .legend-strip {
            max-width: 1500px; margin: 16px auto 0;
            padding: 0 20px;
        }

        .legend-inner {
            background: #ffffff;
            border: 1px solid var(--steel-100);
            border-radius: 12px;
            padding: 14px 22px;
            display: flex; align-items: center;
            gap: 12px; flex-wrap: wrap;
            box-shadow: 0 1px 4px rgba(0,0,0,0.03);
        }

        .legend-label {
            font-size: 0.72em; color: var(--text-muted);
            font-weight: 600; letter-spacing: 1px;
            text-transform: uppercase; margin-right: 4px;
        }

        .legend-chip {
            display: inline-flex; align-items: center; gap: 5px;
            padding: 4px 12px; border-radius: 6px;
            font-size: 0.74em; font-weight: 600;
            border: 1px solid;
        }

        .chip-factor { background: rgba(33,150,243,0.08); color: #1565c0; border-color: rgba(33,150,243,0.25); }
        .chip-regime { background: rgba(156,39,176,0.08); color: #7b1fa2; border-color: rgba(156,39,176,0.25); }
        .chip-garch { background: rgba(255,152,0,0.08); color: #e65100; border-color: rgba(255,152,0,0.25); }
        .chip-kalman { background: rgba(0,188,212,0.08); color: #00838f; border-color: rgba(0,188,212,0.25); }
        .chip-mc { background: rgba(76,175,80,0.08); color: #2e7d32; border-color: rgba(76,175,80,0.25); }

        .legend-note {
            font-size: 0.7em; color: var(--text-muted);
            margin-left: auto; font-style: italic;
        }

        .legend-note b { color: var(--steel-700); font-style: normal; }

        /* ============================================================
           SETTINGS PANEL (Render URL)
           ============================================================ */
        .settings-strip {
            max-width: 1500px; margin: 10px auto 0;
            padding: 0 20px;
        }

        .settings-inner {
            background: #ffffff;
            border: 1px solid var(--steel-100);
            border-radius: 12px;
            padding: 12px 22px;
            display: flex; align-items: center;
            gap: 12px; flex-wrap: wrap;
            box-shadow: 0 1px 4px rgba(0,0,0,0.03);
        }

        .settings-label {
            font-size: 0.75em; color: var(--steel-700);
            font-weight: 700; letter-spacing: 0.5px;
            white-space: nowrap;
        }

        .settings-input {
            flex: 1; min-width: 250px;
            padding: 8px 14px;
            background: var(--steel-50);
            border: 1px solid var(--steel-200);
            border-radius: 8px;
            color: var(--steel-800);
            font-size: 0.82em;
            font-family: 'JetBrains Mono', monospace;
            outline: none; transition: all 0.3s;
        }

        .settings-input:focus {
            border-color: var(--steel-500);
            box-shadow: 0 0 0 3px rgba(70,130,180,0.1);
        }

        .settings-input::placeholder { color: var(--steel-300); }

        .settings-save-btn {
            padding: 8px 20px;
            background: var(--steel-700);
            border: none; border-radius: 8px;
            color: #fff; font-size: 0.78em;
            font-weight: 700; cursor: pointer;
            transition: all 0.3s;
            font-family: 'Inter', sans-serif;
            letter-spacing: 0.5px;
        }

        .settings-save-btn:hover { background: var(--steel-800); }

        .settings-status {
            font-size: 0.72em; font-weight: 600;
            padding: 4px 10px; border-radius: 5px;
            display: none;
        }

        .settings-status.saved {
            display: inline-block;
            background: var(--green-100); color: var(--green-600);
        }

        /* ============================================================
           MAIN CONTENT
           ============================================================ */
        .main-wrap {
            max-width: 1500px; margin: 20px auto;
            padding: 0 20px;
        }

        /* ============================================================
           SIGNAL COLUMNS â€” BUY & SELL
           ============================================================ */
        .signals-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-bottom: 28px;
        }

        .signal-box {
            background: #ffffff;
            border-radius: 14px;
            border: 1px solid var(--steel-100);
            overflow: hidden;
            box-shadow: 0 2px 8px rgba(0,0,0,0.04);
        }

        .signal-box-header {
            display: flex; align-items: center;
            justify-content: space-between;
            padding: 14px 22px;
        }

        .signal-box-header.buy-header {
            background: linear-gradient(135deg, var(--green-50), #ffffff);
            border-bottom: 2px solid var(--green-400);
        }

        .signal-box-header.sell-header {
            background: linear-gradient(135deg, var(--red-50), #ffffff);
            border-bottom: 2px solid var(--red-400);
        }

        .signal-box-title {
            font-size: 1em; font-weight: 800;
            letter-spacing: 1.5px;
        }

        .signal-box-title.buy-title { color: var(--green-600); }
        .signal-box-title.sell-title { color: var(--red-600); }

        .signal-box-count {
            padding: 3px 14px; border-radius: 20px;
            font-size: 0.78em; font-weight: 700;
        }

        .count-buy { background: var(--green-100); color: var(--green-600); }
        .count-sell { background: var(--red-100); color: var(--red-600); }

        .signal-box-body {
            padding: 16px;
            max-height: 80vh;
            overflow-y: auto;
        }

        /* ============================================================
           GRADE SECTIONS (A+, A, B+ inner boxes)
           ============================================================ */
        .grade-section {
            margin-bottom: 16px;
        }

        .grade-section-header {
            display: flex; align-items: center; gap: 10px;
            padding: 8px 14px;
            background: var(--steel-50);
            border: 1px solid var(--steel-100);
            border-radius: 10px 10px 0 0;
            cursor: pointer;
            transition: background 0.2s;
        }

        .grade-section-header:hover { background: var(--steel-100); }

        .grade-badge {
            padding: 3px 12px; border-radius: 6px;
            font-weight: 800; font-size: 0.82em;
            letter-spacing: 1px;
        }

        .grade-badge-aplus { background: linear-gradient(135deg, #dcfce7, #bbf7d0); color: #15803d; border: 1px solid #86efac; }
        .grade-badge-a { background: linear-gradient(135deg, #dbeafe, #bfdbfe); color: #1d4ed8; border: 1px solid #93c5fd; }
        .grade-badge-bplus { background: linear-gradient(135deg, #fef9c3, #fde68a); color: #a16207; border: 1px solid #fcd34d; }

        .grade-section-title {
            font-size: 0.78em; color: var(--text-secondary);
            font-weight: 600; letter-spacing: 0.5px;
        }

        .grade-section-count {
            margin-left: auto; font-size: 0.72em;
            color: var(--text-muted); font-weight: 600;
        }

        .grade-section-toggle {
            font-size: 0.7em; color: var(--text-muted);
            transition: transform 0.3s;
        }

        .grade-section-header.collapsed .grade-section-toggle {
            transform: rotate(-90deg);
        }

        .grade-section-body {
            border: 1px solid var(--steel-100);
            border-top: none;
            border-radius: 0 0 10px 10px;
            padding: 10px;
            display: flex; flex-direction: column;
            gap: 10px;
        }

        .grade-section-body.collapsed { display: none; }

        /* ============================================================
           STOCK CARD (Inside Grade Section)
           ============================================================ */
        .stock-card {
            background: #ffffff;
            border: 1px solid var(--steel-100);
            border-radius: 10px;
            padding: 14px 16px;
            transition: all 0.25s;
            position: relative;
            border-left: 4px solid transparent;
        }

        .stock-card.buy-card { border-left-color: var(--green-500); }
        .stock-card.sell-card { border-left-color: var(--red-500); }

        .stock-card:hover {
            box-shadow: 0 4px 16px rgba(0,0,0,0.08);
            transform: translateY(-1px);
            border-color: var(--steel-200);
        }

        /* Card: Symbol */
        .card-symbol-row {
            display: flex; align-items: center;
            justify-content: space-between;
            margin-bottom: 8px;
        }

        .card-symbol-group {
            display: flex; align-items: center; gap: 8px;
        }

        .card-symbol {
            font-size: 1.05em; font-weight: 800;
            color: var(--steel-900); letter-spacing: 0.5px;
        }

        .fno-tag {
            padding: 1px 7px; font-size: 0.62em;
            font-weight: 700; letter-spacing: 0.8px;
            border-radius: 4px;
            background: #fef9c3; color: #92400e;
            border: 1px solid #fcd34d;
        }

        /* Card: Model Tags */
        .card-models-row {
            display: flex; gap: 4px; flex-wrap: wrap;
            margin-bottom: 10px;
        }

        .mtag {
            padding: 2px 8px; border-radius: 4px;
            font-size: 0.64em; font-weight: 700;
            letter-spacing: 0.5px; transition: all 0.3s;
        }

        .mtag.active { opacity: 1; }
        .mtag.inactive { opacity: 0.2; filter: grayscale(1); }

        .mtag-factor { background: rgba(33,150,243,0.1); color: #1565c0; }
        .mtag-regime { background: rgba(156,39,176,0.1); color: #7b1fa2; }
        .mtag-garch { background: rgba(255,152,0,0.1); color: #e65100; }
        .mtag-kalman { background: rgba(0,188,212,0.1); color: #00838f; }
        .mtag-mc { background: rgba(76,175,80,0.1); color: #2e7d32; }

        /* Card: Prices */
        .card-prices-row {
            display: grid; grid-template-columns: 1fr 1fr 1fr;
            gap: 6px; margin-bottom: 10px;
        }

        .price-cell {
            text-align: center; padding: 6px 4px;
            background: var(--steel-50); border-radius: 6px;
        }

        .price-cell-label {
            font-size: 0.58em; color: var(--text-muted);
            text-transform: uppercase; letter-spacing: 0.8px;
            font-weight: 600; margin-bottom: 2px;
        }

        .price-cell-value {
            font-size: 0.88em; font-weight: 700;
            font-family: 'JetBrains Mono', monospace;
        }

        .pv-entry { color: var(--steel-800); }
        .pv-stop { color: var(--red-600); }
        .pv-target { color: var(--green-600); }

        /* Card: Metrics Row */
        .card-metrics-row {
            display: grid; grid-template-columns: repeat(5, 1fr);
            gap: 5px; margin-bottom: 10px;
        }

        .metric-cell {
            text-align: center; padding: 6px 2px;
            background: var(--steel-50); border-radius: 6px;
        }

        .metric-cell-label {
            font-size: 0.54em; color: var(--text-muted);
            text-transform: uppercase; letter-spacing: 0.5px;
            font-weight: 600; margin-bottom: 2px;
            line-height: 1.2;
        }

        .metric-cell-value {
            font-size: 0.78em; font-weight: 700;
            color: var(--steel-800);
            font-family: 'JetBrains Mono', monospace;
        }

        .mv-good { color: var(--green-600) !important; }
        .mv-warn { color: #d97706 !important; }
        .mv-bad { color: var(--red-600) !important; }

        .confidence-high { color: var(--green-600) !important; font-weight: 800; }
        .confidence-medium { color: #d97706 !important; font-weight: 800; }
        .confidence-low { color: var(--red-600) !important; font-weight: 800; }

        /* Card: Score Bar */
        .card-score-bar {
            display: flex; align-items: center; gap: 8px;
            margin-bottom: 10px;
        }

        .score-track {
            flex: 1; height: 5px; background: var(--steel-100);
            border-radius: 3px; overflow: hidden;
        }

        .score-fill {
            height: 100%; border-radius: 3px;
            transition: width 0.8s ease;
        }

        .sf-high { background: linear-gradient(90deg, #16a34a, #22c55e); }
        .sf-mid { background: linear-gradient(90deg, #d97706, #f59e0b); }
        .sf-low { background: linear-gradient(90deg, #dc2626, #ef4444); }

        .score-num {
            font-size: 0.78em; font-weight: 800;
            min-width: 32px; text-align: right;
            font-family: 'JetBrains Mono', monospace;
        }

        /* Card: Action Buttons (Taken / Not Taken) */
        .card-actions-row {
            display: grid; grid-template-columns: 1fr 1fr;
            gap: 8px;
        }

        .action-btn {
            padding: 7px 8px; border-radius: 7px;
            font-size: 0.75em; font-weight: 700;
            cursor: pointer; transition: all 0.25s;
            text-align: center; border: 1.5px solid;
            font-family: 'Inter', sans-serif;
            letter-spacing: 0.5px;
        }

        .btn-taken {
            background: var(--green-50);
            color: var(--green-600);
            border-color: var(--green-400);
        }

        .btn-taken:hover {
            background: var(--green-100);
            box-shadow: 0 2px 8px rgba(34,197,94,0.2);
        }

        .btn-not-taken {
            background: var(--steel-50);
            color: var(--text-muted);
            border-color: var(--steel-200);
        }

        .btn-not-taken:hover {
            background: var(--steel-100);
        }

        .btn-taken.selected {
            background: var(--green-500);
            color: #fff;
            border-color: var(--green-600);
        }

        .btn-not-taken.selected {
            background: var(--steel-400);
            color: #fff;
            border-color: var(--steel-500);
        }

        /* ============================================================
           EMPTY & ERROR STATES
           ============================================================ */
        .empty-state {
            text-align: center; padding: 50px 20px;
        }

        .empty-icon { font-size: 2.5em; margin-bottom: 12px; opacity: 0.3; }

        .empty-title {
            font-size: 0.95em; color: var(--text-secondary);
            font-weight: 600; margin-bottom: 6px;
        }

        .empty-sub { font-size: 0.8em; color: var(--text-muted); }

        .error-state {
            text-align: center; padding: 30px 20px;
            background: var(--red-50); border: 1px solid rgba(239,68,68,0.2);
            border-radius: 10px; margin: 12px;
        }

        .error-title { font-size: 0.95em; color: var(--red-600); font-weight: 700; margin-bottom: 8px; }
        .error-msg { font-size: 0.8em; color: var(--text-secondary); margin-bottom: 14px; }

        .troubleshoot { text-align: left; max-width: 420px; margin: 0 auto; list-style: none; }

        .troubleshoot li {
            font-size: 0.75em; color: var(--text-secondary);
            padding: 3px 0 3px 18px; position: relative;
        }

        .troubleshoot li::before {
            content: 'â†’'; position: absolute; left: 0;
            color: var(--steel-500); font-weight: 700;
        }

        /* ============================================================
           LOADING OVERLAY
           ============================================================ */
        .loading-overlay {
            display: none; position: fixed;
            top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(240,242,245,0.95);
            z-index: 1000;
            justify-content: center; align-items: center;
            flex-direction: column;
        }

        .loading-overlay.active { display: flex; }

        .spinner {
            width: 50px; height: 50px;
            border: 3px solid var(--steel-100);
            border-top: 3px solid var(--steel-600);
            border-radius: 50%;
            animation: spin 0.8s linear infinite;
            margin-bottom: 20px;
        }

        @keyframes spin { to { transform: rotate(360deg); } }

        .loading-text { color: var(--steel-700); font-size: 1em; font-weight: 700; letter-spacing: 2px; margin-bottom: 6px; }
        .loading-sub { color: var(--text-muted); font-size: 0.82em; }

        .loading-bar {
            margin-top: 16px; width: 260px; height: 4px;
            background: var(--steel-100); border-radius: 2px; overflow: hidden;
        }

        .loading-bar-fill {
            height: 100%;
            background: linear-gradient(90deg, var(--steel-600), var(--steel-400));
            width: 30%; border-radius: 2px;
            animation: barSlide 1.8s ease-in-out infinite;
        }

        @keyframes barSlide { 0%{transform:translateX(-100%)} 100%{transform:translateX(400%)} }

        /* ============================================================
           TRADE JOURNAL
           ============================================================ */
        .journal-section {
            background: #ffffff;
            border: 1px solid var(--steel-100);
            border-radius: 14px;
            overflow: hidden;
            box-shadow: 0 2px 8px rgba(0,0,0,0.04);
            margin-bottom: 28px;
        }

        .journal-header {
            display: flex; align-items: center;
            justify-content: space-between;
            padding: 16px 22px;
            background: var(--steel-50);
            border-bottom: 1px solid var(--steel-100);
        }

        .journal-title {
            font-size: 1em; font-weight: 800;
            color: var(--steel-800); letter-spacing: 1px;
        }

        .journal-count {
            font-size: 0.78em; color: var(--text-muted);
            font-weight: 600;
        }

        .journal-table-wrap {
            overflow-x: auto; padding: 0;
        }

        .journal-table {
            width: 100%; border-collapse: collapse;
            font-size: 0.78em;
        }

        .journal-table th {
            background: var(--steel-50);
            color: var(--steel-700);
            font-weight: 700; font-size: 0.82em;
            letter-spacing: 0.5px; text-transform: uppercase;
            padding: 10px 12px; text-align: left;
            border-bottom: 2px solid var(--steel-200);
            white-space: nowrap;
        }

        .journal-table td {
            padding: 10px 12px;
            border-bottom: 1px solid var(--steel-50);
            color: var(--text-primary);
            vertical-align: middle;
        }

        .journal-table tr:hover td { background: var(--steel-50); }

        .journal-table .dir-buy { color: var(--green-600); font-weight: 700; }
        .journal-table .dir-sell { color: var(--red-600); font-weight: 700; }

        .journal-status {
            padding: 2px 10px; border-radius: 12px;
            font-size: 0.85em; font-weight: 700;
            display: inline-block;
        }

        .js-open { background: #fef9c3; color: #92400e; }
        .js-profit { background: var(--green-100); color: var(--green-600); }
        .js-loss { background: var(--red-100); color: var(--red-600); }

        .journal-input {
            width: 90px; padding: 5px 8px;
            border: 1px solid var(--steel-200);
            border-radius: 6px; font-size: 0.95em;
            font-family: 'JetBrains Mono', monospace;
            color: var(--steel-800);
            background: var(--steel-50);
            outline: none; transition: all 0.3s;
        }

        .journal-input:focus {
            border-color: var(--steel-500);
            box-shadow: 0 0 0 2px rgba(70,130,180,0.1);
        }

        .journal-date-input {
            width: 120px; padding: 5px 8px;
            border: 1px solid var(--steel-200);
            border-radius: 6px; font-size: 0.88em;
            font-family: 'JetBrains Mono', monospace;
            color: var(--steel-800);
            background: var(--steel-50);
            outline: none;
        }

        .journal-delete-btn {
            background: none; border: none;
            color: var(--red-400); font-size: 1.1em;
            cursor: pointer; transition: all 0.2s;
            padding: 4px 8px; border-radius: 4px;
        }

        .journal-delete-btn:hover {
            background: var(--red-50); color: var(--red-600);
        }

        .journal-empty {
            text-align: center; padding: 40px 20px;
            color: var(--text-muted); font-size: 0.85em;
        }

        .pnl-positive { color: var(--green-600); font-weight: 700; }
        .pnl-negative { color: var(--red-600); font-weight: 700; }

        /* ============================================================
           PERFORMANCE ANALYTICS
           ============================================================ */
        .analytics-section {
            background: #ffffff;
            border: 1px solid var(--steel-100);
            border-radius: 14px;
            overflow: hidden;
            box-shadow: 0 2px 8px rgba(0,0,0,0.04);
            margin-bottom: 40px;
        }

        .analytics-header {
            padding: 16px 22px;
            background: var(--steel-50);
            border-bottom: 1px solid var(--steel-100);
        }

        .analytics-title {
            font-size: 1em; font-weight: 800;
            color: var(--steel-800); letter-spacing: 1px;
        }

        .analytics-body { padding: 20px 22px; }

        /* Summary Cards */
        .analytics-cards {
            display: grid;
            grid-template-columns: repeat(6, 1fr);
            gap: 12px; margin-bottom: 24px;
        }

        .analytics-card {
            background: var(--steel-50);
            border: 1px solid var(--steel-100);
            border-radius: 10px;
            padding: 14px 12px;
            text-align: center;
            transition: all 0.2s;
        }

        .analytics-card:hover {
            box-shadow: 0 2px 10px rgba(0,0,0,0.06);
            transform: translateY(-1px);
        }

        .ac-label {
            font-size: 0.62em; color: var(--text-muted);
            text-transform: uppercase; letter-spacing: 0.8px;
            font-weight: 600; margin-bottom: 6px;
        }

        .ac-value {
            font-size: 1.3em; font-weight: 800;
            font-family: 'JetBrains Mono', monospace;
            color: var(--steel-800);
        }

        .ac-sub {
            font-size: 0.65em; color: var(--text-muted);
            margin-top: 3px; font-weight: 500;
        }

        /* Breakdown Grids */
        .analytics-breakdown {
            display: grid; grid-template-columns: 1fr 1fr 1fr;
            gap: 16px;
        }

        .breakdown-box {
            background: var(--steel-50);
            border: 1px solid var(--steel-100);
            border-radius: 10px;
            padding: 16px;
        }

        .bb-title {
            font-size: 0.75em; font-weight: 700;
            color: var(--steel-700); letter-spacing: 0.5px;
            text-transform: uppercase; margin-bottom: 12px;
            padding-bottom: 6px; border-bottom: 1px solid var(--steel-200);
        }

        .bb-row {
            display: flex; justify-content: space-between;
            padding: 5px 0; font-size: 0.8em;
            border-bottom: 1px solid rgba(0,0,0,0.03);
        }

        .bb-row:last-child { border-bottom: none; }
        .bb-key { color: var(--text-secondary); }

        .bb-val {
            font-weight: 700; color: var(--steel-800);
            font-family: 'JetBrains Mono', monospace;
        }

        .analytics-empty {
            text-align: center; padding: 40px;
            color: var(--text-muted); font-size: 0.85em;
        }

        /* ============================================================
           RESPONSIVE
           ============================================================ */
        @media (max-width: 1100px) {
            .signals-grid { grid-template-columns: 1fr; }
            .analytics-cards { grid-template-columns: repeat(3, 1fr); }
            .analytics-breakdown { grid-template-columns: 1fr; }
        }

        @media (max-width: 700px) {
            .header { padding: 18px 16px; }
            .header-content { flex-direction: column; align-items: flex-start; }
            .header-title { font-size: 1.3em; }
            .status-bar { padding: 8px 16px; gap: 12px; }
            .main-wrap { padding: 0 10px; }
            .card-metrics-row { grid-template-columns: repeat(3, 1fr); }
            .card-prices-row { grid-template-columns: 1fr; }
            .analytics-cards { grid-template-columns: repeat(2, 1fr); }
            .legend-inner { flex-direction: column; align-items: flex-start; }
            .legend-note { margin-left: 0; }
        }

        /* ============================================================
           FOOTER
           ============================================================ */
        .footer {
            text-align: center; padding: 20px;
            font-size: 0.7em; color: var(--text-muted);
            border-top: 1px solid var(--steel-100);
            background: #fff;
        }
    </style>
</head>
<body>

    <!-- ============================================================
         HEADER
         ============================================================ -->
    <div class="header">
        <div class="header-content">
            <div class="header-left">
                <div class="header-title">âš¡ QUANT SCANNER <span>v2.0</span></div>
                <div class="header-subtitle">
                    Multi-Layer Swing Scanner â€” <b>Factor</b> Â· <b>Regime</b> Â· <b>GARCH</b> Â· <b>Kalman</b> Â· <b>Monte Carlo</b>
                </div>
            </div>
            <button class="scan-btn" id="scanBtn" onclick="runScan()">âš¡ SCAN NOW</button>
        </div>
    </div>

    <!-- ============================================================
         STATUS BAR
         ============================================================ -->
    <div class="status-bar">
        <div class="status-item">
            <div class="status-dot" id="statusDot"></div>
            <span class="status-label">Status:</span>
            <span class="status-value" id="statusText">Idle</span>
        </div>
        <div class="status-item">
            <span class="status-label">Last Scan:</span>
            <span class="status-value" id="lastScanTime">â€”</span>
        </div>
        <div class="status-item">
            <span class="status-label">Stocks:</span>
            <span class="status-value" id="stockCount">0</span>
        </div>
        <div class="status-item">
            <span class="status-label">Regime:</span>
            <span class="regime-badge regime-unknown" id="regimeTag">UNKNOWN</span>
        </div>
        <div class="status-item">
            <span class="status-label">Signals:</span>
            <span class="status-value">
                <span id="buyCountStatus" style="color:var(--green-600)">0</span> Buy Â·
                <span id="sellCountStatus" style="color:var(--red-600)">0</span> Sell
            </span>
        </div>
    </div>

    <!-- ============================================================
         MODEL LEGEND
         ============================================================ -->
    <div class="legend-strip">
        <div class="legend-inner">
            <span class="legend-label">Models:</span>
            <span class="legend-chip chip-factor">FACTOR <span style="font-weight:400;opacity:0.7">MomentumÂ·QualityÂ·Value</span></span>
            <span class="legend-chip chip-regime">REGIME <span style="font-weight:400;opacity:0.7">HMM Bull/Bear</span></span>
            <span class="legend-chip chip-garch">GARCH <span style="font-weight:400;opacity:0.7">VolÂ·RiskÂ·Stop</span></span>
            <span class="legend-chip chip-kalman">KALMAN <span style="font-weight:400;opacity:0.7">Trend Filter</span></span>
            <span class="legend-chip chip-mc">MC <span style="font-weight:400;opacity:0.7">5K Stress Sim</span></span>
            <span class="legend-note">Signal when <b>3+ models agree</b> Â· Sell: <b>FnO only</b></span>
        </div>
    </div>

    <!-- ============================================================
         SETTINGS â€” Render URL
         ============================================================ -->
    <div class="settings-strip">
        <div class="settings-inner">
            <span class="settings-label">ðŸ”— Render API URL:</span>
            <input type="text" class="settings-input" id="renderUrl"
                   placeholder="Paste your Render URL â€” e.g. https://your-scanner.onrender.com" />
            <button class="settings-save-btn" onclick="saveRenderUrl()">SAVE</button>
            <span class="settings-status" id="settingsStatus">âœ“ Saved</span>
        </div>
    </div>

    <!-- ============================================================
         MAIN CONTENT
         ============================================================ -->
    <div class="main-wrap">

        <!-- ============================================================
             SIGNAL BOXES â€” BUY & SELL
             ============================================================ -->
        <div class="signals-grid">
            <!-- BUY SIGNALS -->
            <div class="signal-box">
                <div class="signal-box-header buy-header">
                    <span class="signal-box-title buy-title">ðŸŸ¢ QUANT BUY</span>
                    <span class="signal-box-count count-buy" id="buyCountBadge">0 signals</span>
                </div>
                <div class="signal-box-body" id="buyList">
                    <div class="empty-state" id="buyEmpty">
                        <div class="empty-icon">ðŸ“Š</div>
                        <div class="empty-title">No Buy Signals Yet</div>
                        <div class="empty-sub">Save your Render URL above and click SCAN NOW</div>
                    </div>
                </div>
            </div>

            <!-- SELL SIGNALS -->
            <div class="signal-box">
                <div class="signal-box-header sell-header">
                    <span class="signal-box-title sell-title">ðŸ”´ QUANT SELL (FnO)</span>
                    <span class="signal-box-count count-sell" id="sellCountBadge">0 signals</span>
                </div>
                <div class="signal-box-body" id="sellList">
                    <div class="empty-state" id="sellEmpty">
                        <div class="empty-icon">ðŸ“‰</div>
                        <div class="empty-title">No Sell Signals Yet</div>
                        <div class="empty-sub">Sell signals generated for FnO stocks only</div>
                    </div>
                </div>
            </div>
        </div>

        <!-- ============================================================
             TRADE JOURNAL
             ============================================================ -->
        <div class="journal-section">
            <div class="journal-header">
                <span class="journal-title">ðŸ“’ TRADE JOURNAL</span>
                <span class="journal-count" id="journalCount">0 trades</span>
            </div>
            <div class="journal-table-wrap">
                <table class="journal-table" id="journalTable">
                    <thead>
                        <tr>
                            <th>Date Taken</th>
                            <th>Category</th>
                            <th>Symbol</th>
                            <th>Direction</th>
                            <th>Entry â‚¹</th>
                            <th>Stop Loss â‚¹</th>
                            <th>Target â‚¹</th>
                            <th>Exit Price â‚¹</th>
                            <th>P&L Status</th>
                            <th>Exit Date</th>
                            <th>Profit / Loss</th>
                            <th></th>
                        </tr>
                    </thead>
                    <tbody id="journalBody">
                    </tbody>
                </table>
                <div class="journal-empty" id="journalEmpty">
                    No trades in journal. Click <b>"âœ“ Taken"</b> on any signal to add it here.
                </div>
            </div>
        </div>

        <!-- ============================================================
             PERFORMANCE ANALYTICS
             ============================================================ -->
        <div class="analytics-section">
            <div class="analytics-header">
                <span class="analytics-title">ðŸ“Š PERFORMANCE ANALYTICS</span>
            </div>
            <div class="analytics-body" id="analyticsBody">
                <div class="analytics-empty" id="analyticsEmpty">
                    Complete trades in the journal above to see performance analytics.
                </div>
                <div id="analyticsContent" style="display:none;">
                    <!-- Summary Cards -->
                    <div class="analytics-cards" id="analyticsCards"></div>
                    <!-- Breakdowns -->
                    <div class="analytics-breakdown" id="analyticsBreakdown"></div>
                </div>
            </div>
        </div>

    </div><!-- /main-wrap -->

    <!-- ============================================================
         LOADING OVERLAY
         ============================================================ -->
    <div class="loading-overlay" id="loadingOverlay">
        <div class="spinner"></div>
        <div class="loading-text">SCANNING UNIVERSE</div>
        <div class="loading-sub">Analyzing ~1,200 stocks across 5 mathematical models...</div>
        <div class="loading-bar"><div class="loading-bar-fill"></div></div>
    </div>

    <!-- ============================================================
         FOOTER
         ============================================================ -->
    <div class="footer">
        QUANT SCANNER v2.0 â€” Factor Â· Regime Â· GARCH Â· Kalman Â· Monte Carlo â€” For educational purposes only. Not financial advice.
    </div>

    <!-- ============================================================
         JAVASCRIPT
         ============================================================ -->
    <script>
        // ============================================================
        // STATE
        // ============================================================
        let isScanning = false;
        let journal = JSON.parse(localStorage.getItem('quantJournal') || '[]');

        // ============================================================
        // RENDER URL â€” Save / Load
        // ============================================================
        function loadRenderUrl() {
            const saved = localStorage.getItem('renderApiUrl');
            if (saved) document.getElementById('renderUrl').value = saved;
        }

        function saveRenderUrl() {
            const url = document.getElementById('renderUrl').value.trim();
            if (!url) return;
            localStorage.setItem('renderApiUrl', url);
            const badge = document.getElementById('settingsStatus');
            badge.classList.add('saved');
            setTimeout(() => badge.classList.remove('saved'), 2000);
        }

        function getRenderUrl() {
            return (document.getElementById('renderUrl').value.trim() ||
                    localStorage.getItem('renderApiUrl') || '').replace(/\/+$/, '');
        }

        // ============================================================
        // SCAN
        // ============================================================
        async function runScan() {
            if (isScanning) return;
            const baseUrl = getRenderUrl();
            if (!baseUrl) {
                alert('Please paste and save your Render API URL first.');
                return;
            }

            isScanning = true;
            showLoading(true);
            setStatus('scanning', 'Scanning...');

            try {
                const res = await fetch(`${baseUrl}/api/scan`, {
                    method: 'GET',
                    headers: { 'Accept': 'application/json' },
                    signal: AbortSignal.timeout(600000)
                });
                if (!res.ok) throw new Error(`HTTP ${res.status}: ${res.statusText}`);
                const data = await res.json();
                if (data.error && !data.buy_signals?.length && !data.sell_signals?.length) throw new Error(data.error);
                renderResults(data);
                setStatus('ready', 'Scan complete');
            } catch (err) {
                console.error(err);
                showScanError(err.message);
                setStatus('error', 'Scan failed');
            } finally {
                isScanning = false;
                showLoading(false);
            }
        }

        // ============================================================
        // RENDER RESULTS
        // ============================================================
        function renderResults(data) {
            const meta = data.scan_metadata || {};
            const buys = data.buy_signals || [];
            const sells = data.sell_signals || [];

            // Counts
            document.getElementById('buyCountStatus').textContent = buys.length;
            document.getElementById('sellCountStatus').textContent = sells.length;
            document.getElementById('buyCountBadge').textContent = `${buys.length} signal${buys.length!==1?'s':''}`;
            document.getElementById('sellCountBadge').textContent = `${sells.length} signal${sells.length!==1?'s':''}`;
            document.getElementById('stockCount').textContent = meta.stocks_scanned || 0;
            document.getElementById('lastScanTime').textContent = meta.timestamp || new Date().toLocaleString();

            updateRegime(meta.market_regime || 'unknown');

            renderSignalColumn('buyList', buys, 'buy');
            renderSignalColumn('sellList', sells, 'sell');
        }

        function renderSignalColumn(containerId, signals, type) {
            const container = document.getElementById(containerId);
            if (!signals.length) {
                container.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-icon">${type==='buy'?'ðŸ“Š':'ðŸ“‰'}</div>
                        <div class="empty-title">No ${type==='buy'?'Buy':'Sell'} Signals</div>
                        <div class="empty-sub">No stocks met 3+ model agreement for ${type}ing</div>
                    </div>`;
                return;
            }

            // Group by grade
            const groups = { 'A+': [], 'A': [], 'B+': [] };
            signals.forEach(s => {
                const g = s.grade || 'B+';
                if (!groups[g]) groups[g] = [];
                groups[g].push(s);
            });

            let html = '';
            for (const [grade, stocks] of Object.entries(groups)) {
                if (!stocks.length) continue;
                const badgeClass = grade==='A+' ? 'grade-badge-aplus' : (grade==='A' ? 'grade-badge-a' : 'grade-badge-bplus');
                const sectionId = `grade-${type}-${grade.replace('+','plus')}`;

                html += `
                    <div class="grade-section">
                        <div class="grade-section-header" onclick="toggleGradeSection('${sectionId}', this)">
                            <span class="grade-badge ${badgeClass}">${grade}</span>
                            <span class="grade-section-title">${grade} Grade Signals</span>
                            <span class="grade-section-count">${stocks.length} stock${stocks.length!==1?'s':''}</span>
                            <span class="grade-section-toggle">â–¼</span>
                        </div>
                        <div class="grade-section-body" id="${sectionId}">
                            ${stocks.map((s,i) => buildCard(s, type, grade, i)).join('')}
                        </div>
                    </div>`;
            }

            container.innerHTML = html;
        }

        // ============================================================
        // BUILD STOCK CARD
        // ============================================================
        function buildCard(s, type, grade, idx) {
            const cardClass = type==='buy' ? 'buy-card' : 'sell-card';
            const cardId = `card-${type}-${grade.replace('+','p')}-${idx}`;

            // Model tags
            const models = s.model_votes || {};
            const mTags = buildModelTags(models);

            // Confidence level
            const conf = s.confidence || 0;
            let confLabel, confClass;
            if (conf >= 65) { confLabel = 'HIGH'; confClass = 'confidence-high'; }
            else if (conf >= 45) { confLabel = 'MEDIUM'; confClass = 'confidence-medium'; }
            else { confLabel = 'LOW'; confClass = 'confidence-low'; }

            // Win rate metrics
            const bt = s.backtest || {};
            const totalTrades = bt.total_trades || 0;
            const winRate = s.historical_win_rate || 0;
            const wonCount = totalTrades > 0 ? Math.round(totalTrades * (bt.win_rate || 0)) : 0;
            const lostCount = totalTrades - wonCount;

            // R:R class
            const rrClass = s.risk_reward >= 2.5 ? 'mv-good' : (s.risk_reward >= 1.5 ? 'mv-warn' : 'mv-bad');

            // Score
            const sc = s.score || 0;
            const scoreClass = sc >= 70 ? 'sf-high' : (sc >= 45 ? 'sf-mid' : 'sf-low');
            const scoreColor = sc >= 70 ? 'var(--green-600)' : (sc >= 45 ? '#d97706' : 'var(--red-600)');

            // Unique id for taken/not-taken state
            const actionId = `${s.symbol}-${type}-${grade}`;

            return `
                <div class="stock-card ${cardClass}" id="${cardId}">
                    <!-- Symbol -->
                    <div class="card-symbol-row">
                        <div class="card-symbol-group">
                            <span class="card-symbol">${s.symbol}</span>
                            ${s.is_fno ? '<span class="fno-tag">FnO</span>' : ''}
                        </div>
                    </div>

                    <!-- Model Tags -->
                    <div class="card-models-row">${mTags}</div>

                    <!-- Prices -->
                    <div class="card-prices-row">
                        <div class="price-cell">
                            <div class="price-cell-label">Entry</div>
                            <div class="price-cell-value pv-entry">â‚¹${fmtNum(s.entry)}</div>
                        </div>
                        <div class="price-cell">
                            <div class="price-cell-label">Stop Loss</div>
                            <div class="price-cell-value pv-stop">â‚¹${fmtNum(s.stop_loss)}</div>
                        </div>
                        <div class="price-cell">
                            <div class="price-cell-label">Target</div>
                            <div class="price-cell-value pv-target">â‚¹${fmtNum(s.target)}</div>
                        </div>
                    </div>

                    <!-- Metrics -->
                    <div class="card-metrics-row">
                        <div class="metric-cell">
                            <div class="metric-cell-label">R:R</div>
                            <div class="metric-cell-value ${rrClass}">${s.risk_reward}x</div>
                        </div>
                        <div class="metric-cell">
                            <div class="metric-cell-label">Confidence</div>
                            <div class="metric-cell-value ${confClass}">${confLabel}</div>
                        </div>
                        <div class="metric-cell">
                            <div class="metric-cell-label">Win Rate</div>
                            <div class="metric-cell-value">${winRate}%</div>
                        </div>
                        <div class="metric-cell">
                            <div class="metric-cell-label">W / L</div>
                            <div class="metric-cell-value">
                                <span style="color:var(--green-600)">${wonCount}</span>/<span style="color:var(--red-600)">${lostCount}</span>
                                <span style="color:var(--text-muted);font-size:0.8em"> (${totalTrades})</span>
                            </div>
                        </div>
                        <div class="metric-cell">
                            <div class="metric-cell-label">Score</div>
                            <div class="metric-cell-value" style="color:${scoreColor}">${sc}%</div>
                        </div>
                    </div>

                    <!-- Score Bar -->
                    <div class="card-score-bar">
                        <div class="score-track">
                            <div class="score-fill ${scoreClass}" style="width:${Math.min(sc,100)}%"></div>
                        </div>
                        <span class="score-num" style="color:${scoreColor}">${sc}</span>
                    </div>

                    <!-- Action Buttons -->
                    <div class="card-actions-row">
                        <button class="action-btn btn-taken" id="taken-${actionId}"
                                onclick="takeTrade('${actionId}', ${JSON.stringify(s).replace(/'/g,"&#39;").replace(/"/g,'&quot;')}, '${type}', '${grade}')">
                            âœ“ Taken
                        </button>
                        <button class="action-btn btn-not-taken" id="nottaken-${actionId}"
                                onclick="notTakeTrade('${actionId}')">
                            âœ— Not Taken
                        </button>
                    </div>
                </div>`;
        }

        function buildModelTags(models) {
            const cfgs = [
                ['factor','FACTOR','mtag-factor'],
                ['regime','REGIME','mtag-regime'],
                ['garch','GARCH','mtag-garch'],
                ['kalman','KALMAN','mtag-kalman'],
                ['monte_carlo','MC','mtag-mc']
            ];
            return cfgs.map(([key,label,cls]) => {
                const m = models[key] || {};
                const act = m.active !== false && m.vote !== 0;
                return `<span class="mtag ${cls} ${act?'active':'inactive'}">${label}</span>`;
            }).join('');
        }

        // ============================================================
        // GRADE SECTION TOGGLE
        // ============================================================
        function toggleGradeSection(sectionId, headerEl) {
            const body = document.getElementById(sectionId);
            if (!body) return;
            body.classList.toggle('collapsed');
            headerEl.classList.toggle('collapsed');
        }

        // ============================================================
        // TRADE ACTIONS â€” Taken / Not Taken
        // ============================================================
        function takeTrade(actionId, signal, type, grade) {
            // Mark button
            const takenBtn = document.getElementById(`taken-${actionId}`);
            const notBtn = document.getElementById(`nottaken-${actionId}`);
            if (takenBtn) { takenBtn.classList.add('selected'); takenBtn.disabled = true; }
            if (notBtn) { notBtn.classList.add('selected'); notBtn.classList.remove('selected'); }

            // Add to journal
            const trade = {
                id: Date.now().toString(),
                dateTaken: new Date().toISOString().split('T')[0],
                category: grade,
                symbol: signal.symbol,
                direction: type.toUpperCase(),
                entry: signal.entry,
                stopLoss: signal.stop_loss,
                target: signal.target,
                exitPrice: null,
                exitDate: null,
                pnlStatus: 'Open',
                pnlPercent: null,
                isFno: signal.is_fno
            };

            journal.push(trade);
            saveJournal();
            renderJournal();
            updateAnalytics();
        }

        function notTakeTrade(actionId) {
            const takenBtn = document.getElementById(`taken-${actionId}`);
            const notBtn = document.getElementById(`nottaken-${actionId}`);
            if (notBtn) { notBtn.classList.add('selected'); notBtn.disabled = true; }
            if (takenBtn) { takenBtn.classList.remove('selected'); }
        }

        // ============================================================
        // JOURNAL â€” Render / Save / Delete / Update
        // ============================================================
        function saveJournal() {
            localStorage.setItem('quantJournal', JSON.stringify(journal));
        }

        function renderJournal() {
            const tbody = document.getElementById('journalBody');
            const empty = document.getElementById('journalEmpty');
            const countEl = document.getElementById('journalCount');

            countEl.textContent = `${journal.length} trade${journal.length!==1?'s':''}`;

            if (!journal.length) {
                tbody.innerHTML = '';
                empty.style.display = 'block';
                return;
            }

            empty.style.display = 'none';

            tbody.innerHTML = journal.map((t, i) => {
                const dirClass = t.direction === 'BUY' ? 'dir-buy' : 'dir-sell';

                // P&L status
                let statusHtml, pnlHtml;
                if (t.exitPrice && t.exitPrice > 0) {
                    let pnl;
                    if (t.direction === 'BUY') {
                        pnl = ((t.exitPrice - t.entry) / t.entry) * 100;
                    } else {
                        pnl = ((t.entry - t.exitPrice) / t.entry) * 100;
                    }
                    t.pnlPercent = pnl;
                    t.pnlStatus = pnl >= 0 ? 'Profit' : 'Loss';

                    const sClass = pnl >= 0 ? 'js-profit' : 'js-loss';
                    statusHtml = `<span class="journal-status ${sClass}">${t.pnlStatus}</span>`;
                    const pClass = pnl >= 0 ? 'pnl-positive' : 'pnl-negative';
                    pnlHtml = `<span class="${pClass}">${pnl >= 0 ? '+' : ''}${pnl.toFixed(2)}%</span>`;
                } else {
                    t.pnlStatus = 'Open';
                    statusHtml = `<span class="journal-status js-open">Open</span>`;
                    pnlHtml = `<span style="color:var(--text-muted)">â€”</span>`;
                }

                return `
                    <tr>
                        <td>${t.dateTaken}</td>
                        <td><span class="grade-badge ${t.category==='A+'?'grade-badge-aplus':t.category==='A'?'grade-badge-a':'grade-badge-bplus'}" style="font-size:0.82em">${t.category}</span></td>
                        <td style="font-weight:700">${t.symbol} ${t.isFno?'<span class="fno-tag" style="font-size:0.6em">FnO</span>':''}</td>
                        <td class="${dirClass}">${t.direction}</td>
                        <td style="font-family:'JetBrains Mono',monospace">â‚¹${fmtNum(t.entry)}</td>
                        <td style="font-family:'JetBrains Mono',monospace;color:var(--red-600)">â‚¹${fmtNum(t.stopLoss)}</td>
                        <td style="font-family:'JetBrains Mono',monospace;color:var(--green-600)">â‚¹${fmtNum(t.target)}</td>
                        <td>
                            <input type="number" class="journal-input" value="${t.exitPrice||''}"
                                   placeholder="0.00"
                                   onchange="updateExitPrice('${t.id}', this.value)" />
                        </td>
                        <td>${statusHtml}</td>
                        <td>
                            <input type="date" class="journal-date-input" value="${t.exitDate||''}"
                                   onchange="updateExitDate('${t.id}', this.value)" />
                        </td>
                        <td>${pnlHtml}</td>
                        <td>
                            <button class="journal-delete-btn" onclick="deleteTrade('${t.id}')" title="Delete trade">âœ•</button>
                        </td>
                    </tr>`;
            }).join('');
        }

        function updateExitPrice(tradeId, value) {
            const trade = journal.find(t => t.id === tradeId);
            if (!trade) return;
            trade.exitPrice = parseFloat(value) || null;

            if (trade.exitPrice && trade.exitPrice > 0) {
                let pnl;
                if (trade.direction === 'BUY') {
                    pnl = ((trade.exitPrice - trade.entry) / trade.entry) * 100;
                } else {
                    pnl = ((trade.entry - trade.exitPrice) / trade.entry) * 100;
                }
                trade.pnlPercent = pnl;
                trade.pnlStatus = pnl >= 0 ? 'Profit' : 'Loss';
            } else {
                trade.pnlStatus = 'Open';
                trade.pnlPercent = null;
            }

            saveJournal();
            renderJournal();
            updateAnalytics();
        }

        function updateExitDate(tradeId, value) {
            const trade = journal.find(t => t.id === tradeId);
            if (!trade) return;
            trade.exitDate = value || null;
            saveJournal();
        }

        function deleteTrade(tradeId) {
            if (!confirm('Delete this trade from the journal?')) return;
            journal = journal.filter(t => t.id !== tradeId);
            saveJournal();
            renderJournal();
            updateAnalytics();
        }

        // ============================================================
        // PERFORMANCE ANALYTICS
        // ============================================================
        function updateAnalytics() {
            const closedTrades = journal.filter(t => t.pnlStatus === 'Profit' || t.pnlStatus === 'Loss');
            const emptyEl = document.getElementById('analyticsEmpty');
            const contentEl = document.getElementById('analyticsContent');

            if (closedTrades.length === 0) {
                emptyEl.style.display = 'block';
                contentEl.style.display = 'none';
                return;
            }

            emptyEl.style.display = 'none';
            contentEl.style.display = 'block';

            // Calculations
            const total = closedTrades.length;
            const openCount = journal.filter(t => t.pnlStatus === 'Open').length;
            const wins = closedTrades.filter(t => t.pnlStatus === 'Profit');
            const losses = closedTrades.filter(t => t.pnlStatus === 'Loss');
            const winRate = ((wins.length / total) * 100).toFixed(1);

            const avgWin = wins.length > 0 ? (wins.reduce((s,t) => s + t.pnlPercent, 0) / wins.length).toFixed(2) : '0.00';
            const avgLoss = losses.length > 0 ? (losses.reduce((s,t) => s + t.pnlPercent, 0) / losses.length).toFixed(2) : '0.00';

            const totalPnl = closedTrades.reduce((s,t) => s + (t.pnlPercent || 0), 0).toFixed(2);
            const bestTrade = closedTrades.length > 0 ? Math.max(...closedTrades.map(t => t.pnlPercent || 0)).toFixed(2) : '0.00';
            const worstTrade = closedTrades.length > 0 ? Math.min(...closedTrades.map(t => t.pnlPercent || 0)).toFixed(2) : '0.00';

            const expectancy = total > 0 ?
                ((wins.length/total * parseFloat(avgWin)) + (losses.length/total * parseFloat(avgLoss))).toFixed(3) : '0.000';

            const profitFactor = Math.abs(parseFloat(avgLoss)) > 0 ?
                (Math.abs(parseFloat(avgWin) * wins.length) / Math.abs(parseFloat(avgLoss) * losses.length)).toFixed(2) : 'âˆž';

            // By grade
            const byGrade = {};
            ['A+','A','B+'].forEach(g => {
                const gt = closedTrades.filter(t => t.category === g);
                const gw = gt.filter(t => t.pnlStatus === 'Profit');
                byGrade[g] = {
                    total: gt.length,
                    wins: gw.length,
                    winRate: gt.length > 0 ? ((gw.length/gt.length)*100).toFixed(1) : 'â€”',
                    pnl: gt.reduce((s,t) => s + (t.pnlPercent||0), 0).toFixed(2)
                };
            });

            // By direction
            const buyTrades = closedTrades.filter(t => t.direction === 'BUY');
            const sellTrades = closedTrades.filter(t => t.direction === 'SELL');
            const buyWins = buyTrades.filter(t => t.pnlStatus === 'Profit');
            const sellWins = sellTrades.filter(t => t.pnlStatus === 'Profit');

            // Summary Cards
            document.getElementById('analyticsCards').innerHTML = `
                <div class="analytics-card">
                    <div class="ac-label">Total Trades</div>
                    <div class="ac-value">${total}</div>
                    <div class="ac-sub">${openCount} open</div>
                </div>
                <div class="analytics-card">
                    <div class="ac-label">Win Rate</div>
                    <div class="ac-value" style="color:${parseFloat(winRate)>=50?'var(--green-600)':'var(--red-600)'}">${winRate}%</div>
                    <div class="ac-sub">${wins.length}W / ${losses.length}L</div>
                </div>
                <div class="analytics-card">
                    <div class="ac-label">Total P&L</div>
                    <div class="ac-value" style="color:${parseFloat(totalPnl)>=0?'var(--green-600)':'var(--red-600)'}">${parseFloat(totalPnl)>=0?'+':''}${totalPnl}%</div>
                    <div class="ac-sub">cumulative</div>
                </div>
                <div class="analytics-card">
                    <div class="ac-label">Avg Win</div>
                    <div class="ac-value" style="color:var(--green-600)">+${avgWin}%</div>
                    <div class="ac-sub">${wins.length} trades</div>
                </div>
                <div class="analytics-card">
                    <div class="ac-label">Avg Loss</div>
                    <div class="ac-value" style="color:var(--red-600)">${avgLoss}%</div>
                    <div class="ac-sub">${losses.length} trades</div>
                </div>
                <div class="analytics-card">
                    <div class="ac-label">Expectancy</div>
                    <div class="ac-value" style="color:${parseFloat(expectancy)>=0?'var(--green-600)':'var(--red-600)'}">${parseFloat(expectancy)>=0?'+':''}${expectancy}%</div>
                    <div class="ac-sub">per trade</div>
                </div>
            `;

            // Breakdowns
            document.getElementById('analyticsBreakdown').innerHTML = `
                <!-- Grade Breakdown -->
                <div class="breakdown-box">
                    <div class="bb-title">ðŸ“Š By Grade</div>
                    ${['A+','A','B+'].map(g => {
                        const d = byGrade[g];
                        return `
                            <div class="bb-row">
                                <span class="bb-key">${g} Grade</span>
                                <span class="bb-val">${d.total} trades Â· ${d.winRate}% WR Â· <span style="color:${parseFloat(d.pnl)>=0?'var(--green-600)':'var(--red-600)'}">${parseFloat(d.pnl)>=0?'+':''}${d.pnl}%</span></span>
                            </div>`;
                    }).join('')}
                </div>

                <!-- Direction Breakdown -->
                <div class="breakdown-box">
                    <div class="bb-title">ðŸ“ˆ By Direction</div>
                    <div class="bb-row">
                        <span class="bb-key">BUY Trades</span>
                        <span class="bb-val">${buyTrades.length} trades Â· ${buyTrades.length>0?((buyWins.length/buyTrades.length)*100).toFixed(1):'â€”'}% WR</span>
                    </div>
                    <div class="bb-row">
                        <span class="bb-key">SELL Trades</span>
                        <span class="bb-val">${sellTrades.length} trades Â· ${sellTrades.length>0?((sellWins.length/sellTrades.length)*100).toFixed(1):'â€”'}% WR</span>
                    </div>
                    <div class="bb-row">
                        <span class="bb-key">Best Trade</span>
                        <span class="bb-val" style="color:var(--green-600)">+${bestTrade}%</span>
                    </div>
                    <div class="bb-row">
                        <span class="bb-key">Worst Trade</span>
                        <span class="bb-val" style="color:var(--red-600)">${worstTrade}%</span>
                    </div>
                </div>

                <!-- Risk Metrics -->
                <div class="breakdown-box">
                    <div class="bb-title">âš¡ Risk Metrics</div>
                    <div class="bb-row">
                        <span class="bb-key">Profit Factor</span>
                        <span class="bb-val">${profitFactor}</span>
                    </div>
                    <div class="bb-row">
                        <span class="bb-key">Expectancy</span>
                        <span class="bb-val" style="color:${parseFloat(expectancy)>=0?'var(--green-600)':'var(--red-600)'}">${parseFloat(expectancy)>=0?'+':''}${expectancy}%</span>
                    </div>
                    <div class="bb-row">
                        <span class="bb-key">Win/Loss Ratio</span>
                        <span class="bb-val">${Math.abs(parseFloat(avgLoss))>0?(Math.abs(parseFloat(avgWin)/parseFloat(avgLoss))).toFixed(2):'âˆž'}x</span>
                    </div>
                    <div class="bb-row">
                        <span class="bb-key">Edge Score</span>
                        <span class="bb-val">${(parseFloat(winRate)/100 * parseFloat(profitFactor!=='âˆž'?profitFactor:5)).toFixed(2)}</span>
                    </div>
                </div>
            `;
        }

        // ============================================================
        // UI HELPERS
        // ============================================================
        function setStatus(state, text) {
            const dot = document.getElementById('statusDot');
            const txt = document.getElementById('statusText');
            dot.className = 'status-dot';
            if (state === 'ready') dot.classList.add('ready');
            else if (state === 'scanning') dot.classList.add('scanning');
            else if (state === 'error') dot.classList.add('error');
            txt.textContent = text;
        }

        function updateRegime(regime) {
            const el = document.getElementById('regimeTag');
            el.textContent = regime.toUpperCase();
            el.className = 'regime-badge';
            if (regime === 'bull') el.classList.add('regime-bull');
            else if (regime === 'bear') el.classList.add('regime-bear');
            else if (regime === 'sideways') el.classList.add('regime-sideways');
            else el.classList.add('regime-unknown');
        }

        function showLoading(show) {
            document.getElementById('loadingOverlay').classList.toggle('active', show);
            document.getElementById('scanBtn').disabled = show;
        }

        function showScanError(msg) {
            const errHtml = `
                <div class="error-state">
                    <div style="font-size:2em;margin-bottom:10px">âš ï¸</div>
                    <div class="error-title">Scan Failed</div>
                    <div class="error-msg">${msg}</div>
                    <ul class="troubleshoot">
                        <li>Check your Render API URL is correct and saved</li>
                        <li>Ensure the Render service is awake (not sleeping)</li>
                        <li>Visit <b>your-url/api/status</b> in browser to check</li>
                        <li>Scan takes 15-45 min for full universe â€” retry</li>
                        <li>Check Render dashboard for deployment errors</li>
                    </ul>
                </div>`;
            document.getElementById('buyList').innerHTML = errHtml;
            document.getElementById('sellList').innerHTML = errHtml;
        }

        function fmtNum(n) {
            if (!n && n !== 0) return 'â€”';
            return Number(n).toLocaleString('en-IN', { minimumFractionDigits: 2, maximumFractionDigits: 2 });
        }

        // ============================================================
        // INIT
        // ============================================================
        window.addEventListener('load', () => {
            loadRenderUrl();
            renderJournal();
            updateAnalytics();
        });
    </script>
</body>
</html>